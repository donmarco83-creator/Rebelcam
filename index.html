<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Kamera ‚Üí Schachbrett</title>
  <style>
    body { margin:0; font-family:sans-serif; background:#0b1020; color:#e5e7eb; }
    header{padding:12px; background:#111827; font-weight:bold;}
    video{width:100%; height:100%; object-fit:cover; aspect-ratio:1/1; background:#000;}
    .video-wrap{position:relative; aspect-ratio:1/1; overflow:hidden;}
    #overlay{position:absolute; inset:0; pointer-events:none; border:2px dashed rgba(255,255,255,.3);}
    #overlay div{position:absolute; background:rgba(255,255,255,.2);}
    #overlay .hline{left:0; right:0; height:1px;}
    #overlay .vline{top:0; bottom:0; width:1px;}
    .handle{position:absolute; width:22px; height:22px; border-radius:50%; background:#fff; border:3px solid #2563eb; touch-action:none;}
    canvas{max-width:100%; height:auto; display:block; margin:10px auto; background:#000;}
    button{margin:4px; padding:8px 12px; border-radius:8px; border:1px solid #1f2937; background:#1e3a8a; color:#fff; cursor:pointer;}
    button.ghost{background:#374151;}
  </style>
</head>
<body>
<header>‚ôüÔ∏è Kamera ‚Üí Brett entzerren</header>
<main style="padding:10px;">
  <div class="video-wrap" id="videoWrap">
    <video id="video" playsinline autoplay muted></video>
    <div id="overlay">
      <div class="hline" style="top:50%;"></div>
      <div class="vline" style="left:50%;"></div>
    </div>
  </div>
  <button id="btnStart">Kamera Start</button>
  <button id="btnShoot">üì∏ Brett fotografieren</button>
  <p id="status"></p>
  <canvas id="photoCanvas"></canvas>
  <div id="handles"></div>
  <button id="btnWarp">Brett entzerren</button>
  <button id="btnResetCorners" class="ghost">Ecken zur√ºcksetzen</button>
  <button id="btnRotL" class="ghost">‚Ü∂ 90¬∞</button>
  <button id="btnRotR" class="ghost">‚Ü∑ 90¬∞</button>
  <button id="btnAutoCorners" class="ghost">Auto-Kanten finden</button>
</main>
<script async src="https://docs.opencv.org/4.x/opencv.js"></script>
<script>
const video=document.getElementById('video');
const btnStart=document.getElementById('btnStart');
const btnShoot=document.getElementById('btnShoot');
const photoCanvas=document.getElementById('photoCanvas');
const ctxPhoto=photoCanvas.getContext('2d');
const statusEl=document.getElementById('status');
const handlesDiv=document.getElementById('handles');
let currentStream=null, latestImage=null;

function updateStatus(msg){statusEl.textContent=msg;}

btnStart.onclick=async()=>{
  try{
    currentStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:'environment'},width:{ideal:1280},height:{ideal:1280},aspectRatio:1},audio:false});
    video.srcObject=currentStream; await video.play();
    updateStatus('Kamera aktiv');
  }catch(e){updateStatus('Fehler: '+e.message);}
};

btnShoot.onclick=()=>{
  if(!video.videoWidth){updateStatus('Video noch nicht bereit');return;}
  const side=Math.min(video.videoWidth, video.videoHeight);
  const sx=(video.videoWidth-side)/2, sy=(video.videoHeight-side)/2;
  photoCanvas.width=side; photoCanvas.height=side;
  ctxPhoto.drawImage(video,sx,sy,side,side,0,0,side,side);
  latestImage=new Image(); latestImage.src=photoCanvas.toDataURL();
  placeHandles();
};

function placeHandles(){
  handlesDiv.innerHTML='';
  const pos=[[10,10],[photoCanvas.width-30,10],[photoCanvas.width-30,photoCanvas.height-30],[10,photoCanvas.height-30]];
  pos.forEach((p,i)=>{
    const h=document.createElement('div'); h.className='handle'; h.style.left=p[0]+'px'; h.style.top=p[1]+'px'; h.dataset.i=i;
    handlesDiv.appendChild(h);
  });
  handlesDiv.style.position='relative'; handlesDiv.style.width=photoCanvas.width+'px';
  handlesDiv.style.height=photoCanvas.height+'px'; handlesDiv.style.margin='auto';
}

// Drag logic
let drag=null; handlesDiv.onmousedown
